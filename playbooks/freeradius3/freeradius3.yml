---

- name: run freeradius3 from runit
  hosts: radius
  vars:
    srv: freeradius3
  become: true
  tasks:
  - name: install freeradius3
    community.general.pkgng:
      name: 'net/{{ srv }}'
  - name: gain access to certs directory and winbindd
    ansible.builtin.file:
      name: "{{ item.path }}"
      mode: "{{ item.mode }}"
      group: freeradius
    loop:
      - { path: '/etc/ssl/private', mode: '0750' }
      - { path: '/etc/ssl/private/certmonger.key', mode: '0640' }
      - { path: '/etc/ssl/certs/certmonger.crt', mode: '0644' }
      - { path: '/var/db/samba4/winbindd_privileged', mode: '0750' }
      - { path: '/var/db/samba4/winbindd_privileged/pipe', mode: '0777' }
  - name: add {{ srv }} runsv directory
    ansible.builtin.file:
      path: '/etc/sv/{{ srv }}'
      state: directory
      mode: '0755'
  - name: add {{ srv }} runsv file
    ansible.builtin.template:
      src: '../../templates/runit/{{ srv }}_run'
      dest: '/etc/sv/{{ srv }}/run'
      owner: root
      group: wheel
      mode: '0755'
  - name: enable {{ srv }} boot
    ansible.builtin.file:
      src: '/etc/sv/{{ srv }}'
      dest: '/var/service/{{ srv }}'
      state: link
